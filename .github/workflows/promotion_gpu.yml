name: Validate and Promote (Full GPU Mode)

on:
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:12.6.0-runtime-ubuntu22.04
      options: --gpus all

    steps:
      # 1Ô∏è‚É£ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          apt-get update && apt-get install -y python3 python3-pip git jq
          pip install --upgrade pip setuptools wheel
          pip install --no-cache-dir -r requirements.txt
          echo "‚úÖ Dependencies installed successfully."

      # 3Ô∏è‚É£ Run experiment
      - name: Run RAG retriever pipeline
        run: |
          echo "üöÄ Running experiment pipeline with GPU..."
          python3 main.py
          echo "‚úÖ main.py execution completed."

      # 4Ô∏è‚É£ Evaluate promotion status
      - name: Evaluate promotion status
        run: |
          if [ -f promotion_result.json ]; then
            echo "üìÑ Found promotion_result.json"
            cat promotion_result.json
            status=$(jq -r '.promotion_status' promotion_result.json)
            if [ "$status" = "approved" ]; then
              echo "‚úÖ Promotion approved."
            else
              echo "‚ùå No improvement detected ‚Äî skipping merge."
              exit 1
            fi
          else
            echo "‚ö†Ô∏è promotion_result.json not found ‚Äî skipping merge."
            exit 1
          fi

      # 5Ô∏è‚É£ ‚úÖ File Validation: Allow only data/, .py, and requirements.txt
      - name: Validate changed files
        run: |
          echo "üîç Checking changed files in this PR..."
          git fetch origin main
          changed_files=$(git diff --name-only origin/main HEAD)
          echo "Changed files:"
          echo "$changed_files"

          # Allow only files under data/, any .py file, or requirements.txt
          allowed_regex='(^data/|\.py$|^requirements\.txt$)'

          # Detect any disallowed files
          disallowed=$(echo "$changed_files" | grep -Ev "$allowed_regex" || true)

          if [ -n "$disallowed" ]; then
            echo "‚ùå Merge blocked! Disallowed files detected:"
            echo "$disallowed"
            echo "Only Python files, data/ files, and requirements.txt are allowed."
            exit 1
          else
            echo "‚úÖ File validation passed ‚Äî safe to merge."
          fi

      # 6Ô∏è‚É£ Auto-merge PR (only if file validation & all steps passed)
      - name: Auto-merge PR
        if: success()
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: merge
